---
title: "Happy R - Investigations Spatiales et Cartographiques "
subtitle: "Suite et Poursuite de la présentation de Jessica du 17/11/17"
author: "Eric & Isabelle"
date: "23 mars 2018"
fontsize: 8pt
output: 
  beamer_presentation:
    fig_width: 6
    fig_height: 3.5
    fig_caption: false
    keep_tex: true
---



<div id="crs-merci-a-nicolas-saby-unite-infosol-orleans-cf.sa-presentation-atelier-resste" class="section level1">
<h1>CRS (Merci à Nicolas SABY, Unité InfoSol, Orléans, cf. sa présentation atelier RESSTE)</h1>
<div id="un-mille-a-lequateur-vaut-une-minute" class="section level2 smaller">
<h2>Un mille à l’équateur vaut une minute</h2>

</div>
<div id="de-multiples-systemes-de-projection" class="section level2 smaller">
<h2>De multiples systèmes de projection</h2>

</div>
<div id="la-france" class="section level2 smaller">
<h2>La France</h2>

</div>
<div id="en-r-deux-facons-theoriques-de-definir-le-systeme-de-projection" class="section level2">
<h2>En R , deux façons théoriques de définir le système de projection</h2>
<ul>
<li><p>par le nom du code EPSG, par exemple WGS84 = 4326 (google) ou 2154 (Lambert-93)</p></li>
<li><p>par l’écriture directe du code à considérer dans le slot proj4string</p></li>
</ul>
<pre class="r"><code>CRSargs(CRS(&quot;+init=epsg:2154&quot;))
## [1] &quot;+init=epsg:2154 +proj=lcc +lat_1=49 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs&quot;</code></pre>
<p>De fait, les objets spatiaux sont souvent dotés d’un CRS initial</p>
<pre class="r"><code>CRSargs(france@proj4string)
## [1] &quot;+proj=longlat +ellps=WGS84&quot;</code></pre>
<p>Si on ne sait, on cherche dans gdal et/ou on va sur le net: <a href="http://spatialreference.org" class="uri">http://spatialreference.org</a></p>
<pre class="r"><code>EPSG &lt;- make_EPSG()
EPSG_Lambert &lt;- EPSG [grep(&quot;Lambert&quot;, EPSG$note), 1:2] 
head(EPSG_Lambert)
##     code                                                        note
## 614 2138                             # NAD27(CGQ77) / Quebec Lambert
## 630 2154                                        # RGF93 / Lambert-93
## 631 2155 # American Samoa 1962 / American Samoa Lambert (deprecated)
## 661 2192                    # ED50 / France EuroLambert (deprecated)
## 663 2194 # American Samoa 1962 / American Samoa Lambert (deprecated)
## 786 2318                               # Ain el Abd / Aramco Lambert</code></pre>
</div>
<div id="en-r-en-pratique-il-faut-transformer-les-coordonnees-via-le-systeme-de-projection" class="section level2">
<h2>En R , en pratique il faut <strong>transformer</strong> les coordonnées via le système de projection</h2>
<ul>
<li>C’est le rôle de la fonction de reprojection <strong>spTransform()</strong></li>
</ul>
<pre class="r"><code>bbox(france)
##         min       max
## x -4.790282  9.562218
## y 41.364927 51.091109
france_Lambert93 &lt;- spTransform(france, CRS(&quot;+init=epsg:2154&quot;))
bbox(france_Lambert93)
##         min     max
## x  124535.3 1242296
## y 6049526.6 7110717</code></pre>
<ul>
<li><p>Cette reprojection est importante pour les calculs de distances (Variogrammes!)</p></li>
<li><p>Exercice: Paris a pour latitude : 48.866667 et pour longitude : 2.333333. Quelles sont ses coordonnées sur une carte Lambert93? Quelles sont ses coordonnées en degrés, minutes, secondes (cf. dd2dms). Celles de Bordeaux sont 48.866667 et 2.333333. Quelle est la distance entre ces deux villes (cf. spDistsN1 et gzAzimuth)</p></li>
<li><p>Exercice: La grille des prévisions CHIMERE est donnée en coordonnées long/lat. Transformer l’objet spatial construit à l’exercice 3 en Lambert93 et visaliser les deux cartes obtenues pour voir l’effet de la projection conique.</p></li>
</ul>
</div>
</div>
<div id="visualisation" class="section level1">
<h1>Visualisation</h1>
<div id="graphe-interactif-avec-locator" class="section level2">
<h2>Graphe interactif avec locator</h2>
<pre class="r"><code>plot(meuse_sp)
region &lt;- locator(type=&quot;o&quot;)
#finir avec Esc

n &lt;- length(region$x)
p &lt;- Polygon(cbind(region$x,region$y)[c(1:n,1),], hole=FALSE)
ps &lt;- Polygons(list(p), ID = &quot;region&quot;)
sps &lt;- SpatialPolygons(list(ps))
plot(meuse_sp[sps,], pch=16, cex=1, add=TRUE, col=&quot;red&quot;)
# Voir ?over
plot(meuse_sp[!is.na(over(meuse_sp,sps)),], pch=16, cex=1, add=TRUE, col=&quot;blue&quot;)
#
pointschoisis&lt;-identify(coordinates(meuse_sp))
print(pointschoisis)
</code></pre>
</div>
<div id="graph-interactif-avec-locator" class="section level2 smaller">
<h2>Graph interactif avec locator</h2>

</div>
<div id="visualisation-treillis-avec-spplot" class="section level2">
<h2>Visualisation treillis avec spplot</h2>
<pre class="r"><code>par(mfrow=c(1,1))
library(RColorBrewer)
bleus &lt;- brewer.pal(7, &quot;Blues&quot;)
lead.st &lt;- as.vector(scale(meuse$lead)); zinc.st &lt;- as.vector(scale(meuse$zinc))
copper.st &lt;- as.vector(scale(meuse$copper)); cadmium.st &lt;- as.vector(scale(meuse$cadmium))
meuse.st&lt;-data.frame(x=meuse$x, y=meuse$y,lead.st,zinc.st,copper.st,cadmium.st)
coordinates(meuse.st) &lt;- ~x+y
cuts=c(-1.2,0,1,2,3,5)
spplot(meuse.st, c(&quot;cadmium.st&quot;, &quot;copper.st&quot;, &quot;lead.st&quot;, &quot;zinc.st&quot;), 
             key.space=&quot;right&quot;, main = &quot;Standardised metallic deposits&quot;, cex = .75,
             cuts = cuts, col.regions=bleus)</code></pre>
<p><img src="/post/2018-03-23-spatial/happyR-230318-PLUS_files/figure-html/visuspplot1-1.png" width="672" /></p>
</div>
<div id="visualisation-spplot-kriege-vs-idw" class="section level2">
<h2>Visualisation spplot Kriege vs IDW</h2>
<pre class="r"><code>library(gstat)
zn &lt;- krige(zinc~1,meuse_sp,meuse_sg)
## [inverse distance weighted interpolation]
meuse_sg$zincIDW &lt;- zn$var1.pred

vgmMeuse &lt;- variogram(zinc~1, meuse_sp, cutoff=1000)
vgmExpMeuse &lt;- fit.variogram(vgmMeuse, vgm(150000, &quot;Exp&quot;, 1000, 40000))
plot(vgmMeuse, vgmExpMeuse, main=&quot;Exponential&quot;, col=&#39;black&#39;)</code></pre>
<p><img src="/post/2018-03-23-spatial/happyR-230318-PLUS_files/figure-html/visuspplot2-1.png" width="672" /></p>
<pre class="r"><code>znkrige&lt;-krige(zinc~1, meuse_sp,meuse_sg, model=vgmExpMeuse)
## [using ordinary kriging]
meuse_sg$zincKRG &lt;- znkrige$var1.pred</code></pre>
</div>
<div id="construction-de-sp.layout" class="section level2">
<h2>Construction de sp.layout</h2>
<pre class="r"><code>river &lt;- list(&quot;sp.polygons&quot;, meuse.riv_poly, col=&#39;darkblue&#39;, fill=T)
north &lt;- list(&quot;SpatialPolygonsRescale&quot;, layout.north.arrow(), offset = 
                c(178750,332500),
              scale = 400)
scale &lt;- list(&quot;SpatialPolygonsRescale&quot;, layout.scale.bar(), offset = 
                c(180200, 329800), scale = 1000, fill=c(&quot;transparent&quot;,&quot;black&quot;))
txt1 &lt;- list(&quot;sp.text&quot;, c(180200, 329950), &quot;0&quot;)
txt2 &lt;- list(&quot;sp.text&quot;, c(181200, 329950), &quot;1 km&quot;)
pts &lt;- list(&quot;sp.points&quot;, meuse_sp, pch = 3, col = &quot;black&quot;)
meuse.layout &lt;- list(river, north, scale, txt1, txt2, pts)</code></pre>
</div>
<div id="visualisation-sp.layoutspplot" class="section level2">
<h2>Visualisation sp.layout+spplot</h2>
<pre class="r"><code>meuse.layout &lt;- list(river, north, scale, txt1, txt2, pts)
spplot(meuse_sg, c(&quot;zincIDW&quot;, &quot;zincKRG&quot;), sp.layout = meuse.layout, cuts=5, col.regions=bleus)</code></pre>
<p><img src="/post/2018-03-23-spatial/happyR-230318-PLUS_files/figure-html/visuspplot4-1.png" width="672" /></p>
</div>
<div id="pistes-pour-le-futur" class="section level2">
<h2>Pistes pour le futur</h2>
<ol style="list-style-type: decimal">
<li><p>Explorer le <strong>package <code>sf</code> </strong> qui associe les fonctionalités de <code>sp</code>, <code>rgdal</code>, et <code>rgeos</code> en un seul package <em>spatial features</em> fondé sur le principe <code>tidyverse</code>.</p></li>
<li><p>Les packages <strong>outils</strong> <code>rgeos</code>,<code>rgdal</code>,<code>maps</code>,<code>maptools</code>… Qui voudrait faire un tour d’horizon? La connection avec les outils SIG?</p></li>
<li>Continuer de comprendre la modélisation <strong>geostatistique</strong> et son inférence. L’étude des dépendances dans le modèle multinormal (d’observation ou latent) peut être approché sous l’angle de la:</li>
</ol>
<ul>
<li><strong>matrice de variance</strong> qui analyse les corrélations spatiales sous forme de variogrammes (packages: structuré sur <code>sp</code>: <code>gstat</code>, ou indépendants: <code>spatial</code>,<code>field</code>,<code>RandomFields</code>, <code>GeoR</code>, etc. )</li>
<li><strong>matrice de précision</strong> qui décrit les indépendances conditionnelles (voir par exemple le package structuré sur <code>sp</code>: <code>spdep</code>) ou son utilisation pour les modèles géostatistiques complexes <code>INLA</code>)</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li><strong>Extensions de la géostatistique </strong> qui intéresseront le réseau RESSTE</li>
</ol>
<ul>
<li><strong>Le spatio-temporel</strong> (packages: structuré sur <code>sp</code>: <code>spacetime</code>) sp+xts+data.frame=spacetime</li>
<li><strong>Approche Bayesiennes</strong> (réplicats MCMC de structure de type cartes)</li>
</ul>
</div>
</div>
